<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en"><head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.2.0/remixicon.css">
   <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
   <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
   <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">  
   <link rel="stylesheet" href="css/supplierdashboard.css">
   <link rel="stylesheet" href="css/forall.css">
   <title>Responsive sidebar Menu | Dark/Light Mode - Bedimcode</title>
</head>
<body>
	<!--=============== HEADER ===============-->
	  <header class="header" id="header">
	     <div class="header__container">
	        <div class="header__logo d-flex align-items-center">
	           
	  
	        </div>
	        <button class="header__toggle" id="header-toggle">
	           <i class="ri-menu-line"></i>
	        </button>
	     </div>
	  </header>

	  <!--=============== SIDEBAR ===============-->
	  <nav class="sidebar" id="sidebar">
	     <div class="sidebar__container">
	        <div class="sidebar__user">
	           <div class="sidebar__img" 			style="display: flex; justify-content: center; align-items: center; border-radius: 50%; overflow: hidden; background-color: #e0e0e0; ">
				<img id="mainProfileImage" style="background-size:cover; width:50px; height:50px;" th:src="${user?.profileImg != null} ? @{/img/{img}(img=${user.profileImg})} : @{/img/default-profile.jpg}" alt="Profile Image">
	           </div>
	           <div class="sidebar__info">
	              <h3 th:text="${user.username}">Rix Methil</h3>
	              <span th:text="${user.email}">rix123@email.com</span>
	           </div>
	        </div>

	        <div class="sidebar__content">
	           <div>
	              <h3 class="sidebar__title">MANAGE</h3>
	              <div class="sidebar__list">
	                 <a th:href="@{/distributor-dashboard}" class="sidebar__link ">
	                    <i class="ri-pie-chart-2-fill"></i>
	                    <span>Dashboard</span>
	                 </a>
	                 <a th:href="@{/distributor-inventory}" class="sidebar__link">
	                    <i class="bi bi-inboxes-fill"></i>
	                    <span>Manage Product</span>
	                 </a>
	                 <a th:href="@{/distributorinventory}" class="sidebar__link active-link">
	                    <i class="bi bi-boxes"></i>
	                    <span>Manage Inventory</span>
	                 </a>
	                 <a th:href="@{/manufacturermarketplace}" class="sidebar__link">
	                   <i class="bi bi-shop"></i>
	                    <span>Manufactuerer MarketPlace</span>
	                 </a>
	                 <a th:href="@{/distributororderhistory}" class="sidebar__link">
	                    <i class="ri-arrow-up-down-line"></i>
	                    <span>Orders History with Manufactuerer</span>
	                 </a>
	                 <a th:href="@{/notifications}" class="sidebar__link">
	                    <i class="ri-notification-2-fill"></i>
	                    <span>Notifications</span>
	                 </a>
	                 <a th:href="@{/distributororderfromcustomer}" class="sidebar__link">
	                    <i class="bi bi-journal-check"></i>
	                    <span>Order from Customer</span>
	                 </a>
	                 
	                 	
	              </div>
	           </div>
	           <div>
	              <h3 class="sidebar__title">SETTINGS</h3>
	              <div class="sidebar__list">
	                 <a th:href="@{/distriprofile}" class="sidebar__link">
	                    <i class="ri-settings-3-fill"></i>
	                    <span>Profile Settings</span>
	                 </a>
	                
	                 
	              </div>
	           </div>
	        </div>
	        <div class="sidebar__actions">
	           <button>
	              <i class="ri-moon-clear-fill sidebar__link sidebar__theme" id="theme-button">
	                 <span>Theme</span>
	              </i>
	           </button>
	           <button class="sidebar__link" id="logoutBtn">
	              <i class="ri-logout-box-r-fill"></i>
	              <span>Log Out</span>
	           </button>
	        </div>
	     </div>
	  </nav>

   <main class="main container-fluid" id="main">
     <h3>Delivered Items</h3>
     <table class="table table-striped" id="deliveredItemsTable">
         <thead>
             <tr>
                 <th>Item Name</th>
                 <th>Quantity</th>
                 <th>Cost</th>
                 <th>Added Date</th>
                 
             </tr>
         </thead>
         <tbody>
             <tr th:each="item : ${deliveredItems}">
                 <td th:text="${item.name}">Item Name</td>
                 <td th:text="${item.quantity}">Quantity</td>
                 <td th:text="${item.cost}">Cost</td>
                 <td th:text="${item.addedDate}">Added Date</td>
                 
             </tr>
         </tbody>
     </table>
	 
	      <button class="btn btn-primary mt-5" data-bs-toggle="modal" data-bs-target="#addItemModal">Add New Item</button>
     <h3 class="mt-4">Saved Items</h3>
<table class="table table-striped" id="savedItemsTable">
    <thead>
        <tr>
            <th>Item Name</th>
            <th>Quantity</th>
            <th>Cost</th>
            <th>Cost Per Unit</th>
            <th>Added Date</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

     
   </main>

   <!-- Add Item Modal -->
<div class="modal fade" id="addItemModal" tabindex="-1" aria-labelledby="addItemModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addItemModalLabel">Add/Edit Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="itemForm" th:action="@{/distributorinventory/add}" method="post">
                    <input type="hidden" id="itemId" name="itemId" />
                    <div class="mb-3">
                        <label for="itemName" class="form-label">Item Name</label>
                        <select class="form-control" id="itemName" name="itemName" required onchange="updateMaxQuantity()">
                            <option th:each="item : ${inventoryItems}" 
                                    th:value="${item.name}" 
                                    th:text="${item.name}"
                                    th:data-quantity="${item.quantity}"></option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="itemQuantity" class="form-label">Quantity</label>
                        <input type="number" class="form-control" id="itemQuantity" name="itemQuantity" required
                               oninput="validateQuantity()">
                        <small class="text-danger" id="quantityError" style="display: none;">Quantity cannot exceed available stock.</small>
                    </div>
                    <div class="mb-3">
                        <label for="itemCost" class="form-label">Cost</label>
                        <input type="number" class="form-control" id="itemCost" name="itemCost" required
                               oninput="calculateCostPerUnit()">
                    </div>
                    <div class="mb-3">
                        <label for="itemCostPerUnit" class="form-label">Cost Per Unit</label>
                        <input type="number" class="form-control" id="itemCostPerUnit" name="itemCostPerUnit" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="itemAddedDate" class="form-label">Added Date</label>
                        <input type="date" class="form-control" id="itemAddedDate" name="itemAddedDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="category" class="form-label">Category</label>
                        <select class="form-control" id="category" name="category" required>
                            <option th:each="category : ${categories}" 
                                    th:value="${category.categoryId}" 
                                    th:text="${category.categoryName}"></option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Item</button>
                </form>
            </div>
        </div>
    </div>
</div>


<script th:inline="javascript">
    const distributorId = /*[[${distributor.distributorId}]]*/ null;
    window.onload = () => {
        fetchDeliveredItems();
        fetchInventoryItems();
    };
</script>
   <script th:src="@{/js/distributorInventory.js}"></script>
   <script th:src="@{/js/forall.js}"></script>
   <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>  
   <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.0.7/dist/umd/popper.min.js"></script>  
   <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
   <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
   <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
   <script>
    // Function to update the maximum allowed quantity based on the selected item
    function updateMaxQuantity() {
        const itemNameSelect = document.getElementById('itemName');
        const selectedOption = itemNameSelect.options[itemNameSelect.selectedIndex];
        const maxQuantity = selectedOption.getAttribute('data-quantity');
        const quantityInput = document.getElementById('itemQuantity');

        // Set the max attribute for the quantity input
        quantityInput.setAttribute('max', maxQuantity);
    }

    // Function to validate the quantity input
    function validateQuantity() {
        const quantityInput = document.getElementById('itemQuantity');
        const maxQuantity = quantityInput.getAttribute('max');
        const quantityError = document.getElementById('quantityError');

        if (parseInt(quantityInput.value) > parseInt(maxQuantity)) {
            quantityError.style.display = 'block';
            quantityInput.setCustomValidity('Quantity cannot exceed available stock.');
        } else {
            quantityError.style.display = 'none';
            quantityInput.setCustomValidity('');
        }
    }

    // Function to calculate cost per unit
    function calculateCostPerUnit() {
        const quantityInput = document.getElementById('itemQuantity');
        const costInput = document.getElementById('itemCost');
        const costPerUnitInput = document.getElementById('itemCostPerUnit');

        const quantity = parseFloat(quantityInput.value);
        const cost = parseFloat(costInput.value);

        if (quantity > 0 && cost > 0) {
            const costPerUnit = cost / quantity;
            costPerUnitInput.value = costPerUnit.toFixed(2);
        } else {
            costPerUnitInput.value = '';
        }
    }
    
 // Edit an item
    /* function editItem(itemId) {
        fetch(`/api/distri/item/${itemId}`)
            .then(response => {
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return response.json();
            })
            .then(item => {
                // Populate the form with the item details
                document.getElementById('itemId').value = item.orderItemId || '';
                document.getElementById('itemName').value = item.manuProduct?.name || '';
                document.getElementById('itemQuantity').value = item.quantity || 0;
                document.getElementById('itemCost').value = item.manuProduct?.cost || 0.0;
                document.getElementById('itemCostPerUnit').value = item.manuProduct?.costPerUnit || 0.0;
                document.getElementById('itemAddedDate').value = item.distriOrder?.orderDate?.split('T')[0] || '';
                document.getElementById('category').value = item.manuProduct?.category?.categoryId || '';

                // Show the modal
                const modal = new bootstrap.Modal(document.getElementById('addItemModal'));
                modal.show();
            })
            .catch(error => {
                console.error('Error fetching item details:', error);
                alert('Failed to fetch item details. Please try again later.');
            });
    } */

    /* function deleteItem(itemId) {
        if (confirm('Are you sure you want to delete this item?')) {
            fetch(`/api/distri/item/${itemId}`, { method: 'DELETE' })
                .then(response => {
                    if (response.ok) {
                        fetchDeliveredItems(); // Refresh the table after deletion
                    } else {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                })
                .catch(error => {
                    console.error('Error deleting item:', error);
                    alert('Failed to delete item. Please try again later.');
                });
        }
    } */
</script>
</body>
</html>
   <!-- <script>
     const distributorId = 1;

     window.onload = () => {
         fetchDeliveredItems();
         fetchInventoryItems();
     };

     function fetchDeliveredItems() {
         fetch(`/api/delivered-items?distributorId=${distributorId}`)
             .then(response => response.json())
             .then(data => {
                 const tableBody = document.querySelector('#deliveredItemsTable tbody');
                 tableBody.innerHTML = '';
                 data.forEach(item => {
                     const row = document.createElement('tr');
                     row.innerHTML = `
                         <td>${item.name}</td>
                         <td>${item.quantity}</td>
                         <td>${item.cost}</td>
                         <td>${item.addedDate}</td>
                         <td>
                             <button class="btn btn-warning btn-sm" onclick="editItem(${item.id}, 'delivered')">Edit</button>
                             <button class="btn btn-danger btn-sm" onclick="deleteItem(${item.id}, 'delivered')">Delete</button>
                         </td>
                     `;
                     tableBody.appendChild(row);
                 });
             })
             .catch(error => console.error('Error fetching delivered items:', error));
     }

     function fetchInventoryItems() {
         fetch(`/api/inventory-items?distributorId=${distributorId}`)
             .then(response => response.json())
             .then(data => {
                 const tableBody = document.querySelector('#inventoryItemsTable tbody');
                 tableBody.innerHTML = '';
                 data.forEach(item => {
                     const row = document.createElement('tr');
                     row.innerHTML = `
                         <td>${item.name}</td>
                         <td>${item.quantity}</td>
                         <td>${item.cost}</td>
                         <td>${item.costPerUnit}</td>
                         <td>${item.addedDate}</td>
                         <td>
                             <button class="btn btn-warning btn-sm" onclick="editItem(${item.id}, 'inventory')">Edit</button>
                             <button class="btn btn-danger btn-sm" onclick="deleteItem(${item.id}, 'inventory')">Delete</button>
                         </td>
                     `;
                     tableBody.appendChild(row);
                 });
             })
             .catch(error => console.error('Error fetching inventory items:', error));
     }

     function editItem(itemId, type) {
         const url = type === 'delivered' ? `/api/delivered-items/${itemId}` : `/api/item/${itemId}`; // Updated URL
         fetch(url)
             .then(response => {
                 if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                 return response.json();
             })
             .then(item => {
                 document.getElementById('itemId').value = item.id;
                 document.getElementById('itemName').value = item.name;
                 document.getElementById('itemQuantity').value = item.quantity;
                 document.getElementById('itemCost').value = item.cost;
                 document.getElementById('itemCostPerUnit').value = item.costPerUnit || '';
                 document.getElementById('itemAddedDate').value = item.addedDate.split('T')[0];
                 // Explicitly show the modal
                 const modal = new bootstrap.Modal(document.getElementById('addItemModal'));
                 modal.show();
             })
             .catch(error => console.error('Error fetching item details:', error));
     }

     document.getElementById('itemForm').addEventListener('submit', function (event) {
         event.preventDefault();
         const itemId = document.getElementById('itemId').value;
         const item = {
             name: document.getElementById('itemName').value,
             quantity: document.getElementById('itemQuantity').value,
             cost: document.getElementById('itemCost').value,
             costPerUnit: document.getElementById('itemCostPerUnit').value,
             addedDate: document.getElementById('itemAddedDate').value
         };

         let url = `/api/inventory-items?distributorId=${distributorId}`;
         let method = 'POST';

         if (itemId) {
             url = `/api/inventory-items/${itemId}?distributorId=${distributorId}`;
             method = 'PUT';
         }

         fetch(url, {
             method: method,
             headers: {
                 'Content-Type': 'application/json'
             },
             body: JSON.stringify(item)
         })
             .then(response => response.json())
             .then(data => {
                 const modal = bootstrap.Modal.getInstance(document.getElementById('addItemModal'));
                 modal.hide();
                 fetchInventoryItems();
             })
             .catch(error => console.error('Error saving item:', error));
     });

     function deleteItem(itemId, type) {
         if (confirm('Are you sure you want to delete this item?')) {
             const url = type === 'delivered' ? `/api/delivered-items/${itemId}` : `/api/inventory-items/${itemId}`;
             fetch(url, {
                 method: 'DELETE'
             })
                 .then(response => {
                     if (response.ok) {
                         if (type === 'delivered') fetchDeliveredItems();
                         else fetchInventoryItems();
                     } else {
                         console.error('Error deleting item');
                     }
                 })
                 .catch(error => console.error('Error deleting item:', error));
         }
     }
   </script> -->
