<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">

   <!--=============== REMIXICONS ===============-->
   <link rel="stylesheet" th:href="@{https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.2.0/remixicon.css}">
   <link th:href="@{https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css}" rel="stylesheet">
   <link th:href="@{https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css}" rel="stylesheet">
   <link th:href="@{https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css}" rel="stylesheet">  
   <link rel="stylesheet" th:href="@{/css/supplierdashboard.css}">

   <!--=============== CSS ===============-->
   <link rel="stylesheet" th:href="@{/css/forall.css}">

   <title>Responsive sidebar Menu | Dark/Light Mode - Bedimcode</title>
</head>
<body>
   <!--=============== HEADER ===============-->
   <header class="header" id="header">
      <div class="header__container">
         <div class="header__logo d-flex align-items-center">
            
   
         </div>
         <button class="header__toggle" id="header-toggle">
            <i class="ri-menu-line"></i>
         </button>
      </div>
   </header>

   <!--=============== SIDEBAR ===============-->
   <nav class="sidebar" id="sidebar">
      <div class="sidebar__container">
         <div class="sidebar__user">
            <div class="sidebar__img" 			style="display: flex; justify-content: center; align-items: center; border-radius: 50%; overflow: hidden; background-color: #e0e0e0; ">
				<img id="mainProfileImage" style="background-size:cover; width:50px; height:50px;" th:src="${user?.profileImg != null} ? @{/img/{img}(img=${user.profileImg})} : @{/img/default-profile.jpg}" alt="Profile Image">
            </div>
            <div class="sidebar__info">
               <h3 th:text="${user.username}">Rix Methil</h3>
               <span th:text="${user.email}">rix123@email.com</span>
            </div>
         </div>

         <div class="sidebar__content">
            <div>
               <h3 class="sidebar__title">MANAGE</h3>
               <div class="sidebar__list">
                  <a th:href="@{/distributor-dashboard}" class="sidebar__link active-link">
                     <i class="ri-pie-chart-2-fill"></i>
                     <span>Dashboard</span>
                  </a>
                  <a th:href="@{/distributor-inventory}" class="sidebar__link">
                     <i class="bi bi-inboxes-fill"></i>
                     <span>Manage Product</span>
                  </a>
                  <a th:href="@{/distributorinventory}" class="sidebar__link">
                     <i class="bi bi-boxes"></i>
                     <span>Manage Inventory</span>
                  </a>
                  <a th:href="@{/manufacturermarketplace}" class="sidebar__link">
                    <i class="bi bi-shop"></i>
                     <span>Manufactuerer MarketPlace</span>
                  </a>
                  <a th:href="@{/distributororderhistory}" class="sidebar__link">
                     <i class="ri-arrow-up-down-line"></i>
                     <span>Orders History with Manufactuerer</span>
                  </a>
                  <a th:href="@{/notifications}" class="sidebar__link">
                     <i class="ri-notification-2-fill"></i>
                     <span>Notifications</span>
                  </a>
                  <a th:href="@{/distributororderfromcustomer}" class="sidebar__link">
                     <i class="bi bi-journal-check"></i>
                     <span>Order from Customer</span>
                  </a>
                  
                  	
               </div>
            </div>
            <div>
               <h3 class="sidebar__title">SETTINGS</h3>
               <div class="sidebar__list">
                  <a th:href="@{/distriprofile}" class="sidebar__link">
                     <i class="ri-settings-3-fill"></i>
                     <span>Profile Settings</span>
                  </a>
                 
                  
               </div>
            </div>
         </div>
         <div class="sidebar__actions">
            <button>
               <i class="ri-moon-clear-fill sidebar__link sidebar__theme" id="theme-button">
                  <span>Theme</span>
               </i>
            </button>
            <button class="sidebar__link" id="logoutBtn">
               <i class="ri-logout-box-r-fill"></i>
               <span>Log Out</span>
            </button>
         </div>
      </div>
   </nav>

   <!--=============== MAIN ===============-->
   <main class="main container-fluid" id="main">
      <div class="row">
         <div class="col-md-4 mt-2">
          <div id="chat-placeholder"></div>
   		<div th:replace="~{distriChat :: chatFragment}"></div>
   		<input type="hidden" id="distributorId" th:value="${distributor?.distributorId}">
            <div class="flex-box" style="background-image: linear-gradient(230deg, #ffc480, #ff763b); color: white;">
                    <h3>Products Sold</h3>
                    <p id="productsSold">Loading...</p>
                    
                </div>
            </div>
            <div class="col-md-4 mt-2">
                <div class="flex-box" style="background-image: linear-gradient(230deg, #759bff, #843cf6); color: white;">
                    <h3>Net Profit</h3>
                    <p id="netProfit">Loading...</p>
                   
                </div>
            </div>
            <div class="col-md-4 mt-2">
                <div class="flex-box" style="background-image: linear-gradient(230deg, #fc5286, #fbaaa2); color: white;">
                    <h3>Overall Rating</h3>
                    <p th:text="${distributor.rating}">Loading...</p>
                    
                </div>
         </div>
      </div>

      <div class="chart-container mt-4">
		<div class="col-11 mb-4">
         <h2>Sales in a Month</h2>
         <canvas id="monthlySalesChart"></canvas></div>
      </div>

      <div class="row mt-4">
         <div class="col-md-5">
            <div class="chart-container">
               <h2>Order Completion (Bar Graph)</h2>
               <canvas id="completionRateChart"></canvas>
            </div>
			
         </div>
        
      </div>
   </main>

   <!--=============== MAIN JS ===============-->
     <script th:inline="javascript">
    const loggedInUserId = /*[[${user.userId}]]*/ null;
</script>
<script th:src="@{/js/distriChat.js}"></script>
   <script th:src="@{/js/forall.js}"></script>
   <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>  
   <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.0.7/dist/umd/popper.min.js"></script>  
   <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
   <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
   <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
   <script>
   document.addEventListener("DOMContentLoaded", function () {
	    const distributorId = document.getElementById("distributorId").value;

	    // Fetch and display stats
	    fetch(`/api/orders/stats/${distributorId}`)
	        .then(response => response.json())
	        .then(data => {
	            document.getElementById("productsSold").innerText = data.productsSold || 0;
	            document.getElementById("netProfit").innerText = `$${data.netProfit?.toFixed(2) || 0}`;
	            document.getElementById("pendingOrders").innerText = data.pendingOrders || 0;
	        })
	        .catch(error => console.error("Error fetching stats:", error));

	    // Fetch and display monthly sales
	    fetch(`/api/orders/monthly-sales/${distributorId}`)
	        .then(response => response.json())
	        .then(data => {
	            const labels = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
	            const salesData = new Array(12).fill(0);
	            data.forEach(([month, revenue]) => {
	                salesData[month - 1] = revenue;
	            });

	            const ctx = document.getElementById('monthlySalesChart').getContext('2d');
	            new Chart(ctx, {
	                type: 'line',
	                data: {
	                    labels: labels,
	                    datasets: [{
	                        label: 'Monthly Sales',
	                        data: salesData,
	                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
	                        borderColor: 'rgba(54, 162, 235, 1)',
	                        borderWidth: 2
	                    }]
	                },
	                options: {
	                    scales: {
	                        y: {
	                            beginAtZero: true
	                        }
	                    }
	                }
	            });
	        })
	        .catch(error => console.error("Error fetching monthly sales:", error));

	    // Fetch and display completion rate
	    fetch(`/api/orders/completion-rate/${distributorId}`)
	        .then(response => response.json())
	        .then(data => {
	            const ctx = document.getElementById('completionRateChart').getContext('2d');
	            new Chart(ctx, {
	                type: 'pie',
	                data: {
	                    labels: ["Completed", "Pending"],
	                    datasets: [{
	                        label: 'Order Completion Rate',
	                        data: [data.completed, data.total - data.completed],
	                        backgroundColor: ["#36A2EB", "#FF6384"],
	                        borderWidth: 1
	                    }]
	                }
	            });
	        })
	        .catch(error => console.error("Error fetching completion rate:", error));
	});
    </script>
</body>
</html>